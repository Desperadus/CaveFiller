name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Run pytest
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest -q

  build:
    name: Build package
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check whether pyproject version changed
        id: version_gate
        run: |
          python - <<'PY'
          import os
          import pathlib
          import subprocess
          import sys

          if sys.version_info < (3, 11):
              raise RuntimeError("Python 3.11+ required for tomllib")

          import tomllib

          pyproject = pathlib.Path("pyproject.toml")
          current_version = tomllib.loads(pyproject.read_text())["project"]["version"]

          try:
              previous_text = subprocess.check_output(
                  ["git", "show", "HEAD^:pyproject.toml"],
                  text=True,
              )
              previous_version = tomllib.loads(previous_text)["project"]["version"]
          except subprocess.CalledProcessError:
              previous_version = None

          output_file = pathlib.Path(os.environ["GITHUB_OUTPUT"])
          with output_file.open("a", encoding="utf-8") as f:
              if previous_version is None:
                  f.write("changed=false\n")
                  print("No previous commit available to compare; skipping publish.")
              elif previous_version != current_version:
                  f.write("changed=true\n")
                  f.write(f"version={current_version}\n")
                  print(f"Version changed: {previous_version} -> {current_version}. Publishing enabled.")
              else:
                  f.write("changed=false\n")
                  print(f"Version unchanged ({current_version}); skipping publish.")
          PY

      - name: Build distributions
        if: steps.version_gate.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Publish summary
        if: steps.version_gate.outputs.changed == 'false'
        run: echo "Skipping PyPI publish because pyproject.toml version did not change on this push."

      - name: Publish package distributions to PyPI
        if: steps.version_gate.outputs.changed == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
