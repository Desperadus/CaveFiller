name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Run pytest
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest -q

  build:
    name: Build package
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build distributions
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check whether pyproject version differs from PyPI
        id: version_gate
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import urllib.error
          import urllib.request
          import sys

          if sys.version_info < (3, 11):
              raise RuntimeError("Python 3.11+ required for tomllib")

          import tomllib

          pyproject = pathlib.Path("pyproject.toml")
          project = tomllib.loads(pyproject.read_text())["project"]
          package_name = project["name"]
          current_version = project["version"]

          pypi_url = f"https://pypi.org/pypi/{package_name}/json"
          pypi_latest_version = None
          release_exists = False

          try:
              with urllib.request.urlopen(pypi_url) as response:
                  data = json.load(response)
              pypi_latest_version = data["info"]["version"]
              release_exists = current_version in data.get("releases", {})
          except urllib.error.HTTPError as exc:
              if exc.code != 404:
                  raise

          output_file = pathlib.Path(os.environ["GITHUB_OUTPUT"])
          with output_file.open("a", encoding="utf-8") as f:
              if pypi_latest_version is None:
                  f.write("changed=true\n")
                  f.write(f"version={current_version}\n")
                  print(
                      f"Package {package_name} is not on PyPI yet. "
                      f"Publishing version {current_version}."
                  )
              elif release_exists:
                  f.write("changed=false\n")
                  print(
                      f"Version {current_version} already exists on PyPI "
                      f"(latest: {pypi_latest_version}). Skipping publish."
                  )
              elif pypi_latest_version != current_version:
                  f.write("changed=true\n")
                  f.write(f"version={current_version}\n")
                  print(
                      f"PyPI latest is {pypi_latest_version}; pyproject has "
                      f"{current_version}. Publishing enabled."
                  )
              else:
                  f.write("changed=false\n")
                  print(
                      f"PyPI latest already matches pyproject version "
                      f"({current_version}). Skipping publish."
                  )
          PY

      - name: Build distributions
        if: steps.version_gate.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Publish summary
        if: steps.version_gate.outputs.changed == 'false'
        run: echo "Skipping PyPI publish because this pyproject.toml version already exists on PyPI."

      - name: Publish package distributions to PyPI
        if: steps.version_gate.outputs.changed == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
